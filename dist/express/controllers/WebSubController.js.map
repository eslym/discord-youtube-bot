{"version":3,"sources":["../src/express/controllers/WebSubController.ts"],"names":[],"mappings":"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","file":"WebSubController.js","sourcesContent":["import {BaseController} from \"./BaseController\";\nimport crypto = require(\"crypto\");\nimport {parseStringPromise} from \"xml2js\";\nimport * as moment from \"moment\";\nimport {logger} from \"../../logger\";\nimport {WebSub} from \"../../models/WebSub\";\nimport {Subscription} from \"../../models/Subscription\";\nimport {Notification} from \"../../models/Notification\";\nimport {Op} from \"sequelize\";\nimport {YoutubeVideo} from \"../../models/YoutubeVideo\";\n\nexport class WebSubController extends BaseController {\n    async subscribe() {\n        let websub: WebSub = await this.resolveParam<Promise<WebSub>>('websub', (id)=>WebSub.findByPk(id), true);\n        this.response.send(this.request.query['hub.challenge']);\n        let data = await websub.fetchSnippet();\n        let title = data.snippet.title;\n        if (this.request.query['hub.mode'] === 'subscribe') {\n            if (websub.expires_at === null) {\n                console.info(`[WebSub] Subscribed ${title}`);\n            } else {\n                console.info(`[WebSub] Renewed ${title}`);\n            }\n            websub.expires_at = moment()\n                .add({second: Number.parseInt(this.request.query['hub.lease_seconds'] as string)})\n                .toDate();\n            websub.save();\n        } else if (this.request.query['hub.mode'] === 'unsubscribe') {\n            logger.log(`[WebSub] Unsubscribed ${title}`);\n            await YoutubeVideo.destroy({\n                where: {\n                    sub_id: websub.id\n                }\n            });\n            let ids = await Subscription.findAll({\n                attributes: ['id'],\n                where: {\n                    sub_id: websub.id,\n                }\n            }).map(s => s.id);\n            await Notification.destroy({\n                where: {\n                    subscription_id: {[Op.in]: ids}\n                }\n            });\n            await Subscription.destroy({\n                where: {\n                    id: {[Op.in]: ids}\n                }\n            })\n            await websub.destroy();\n        }\n    }\n\n    async callback() {\n        let websub: WebSub = await this.resolveParam<Promise<WebSub>>('websub', (id)=>WebSub.findByPk(id), true);\n        this.response.send('OK');\n        this.request.body = await parseStringPromise(this.request.raw.toString());\n        let [algo, sig] = (this.request.headers['x-hub-signature'] as string).split('=', 2);\n        let hmac = crypto.createHmac(algo, websub.secret);\n        hmac.update(this.request.raw);\n        let compute = hmac.digest().toString('hex');\n        if (sig.toLowerCase() !== compute) {\n            logger.warn(`[WebSub] Invalid signature ${sig}`)\n            return;\n        }\n        let data = await websub.fetchSnippet();\n        let title = data.snippet.title;\n        logger.info(`[WebSub] Notification received for ${title}`);\n        if(this.request.body.feed['at:deleted-entry'] !== undefined){\n            let entry = this.request.body.feed['at:deleted-entry'][0];\n            let id = entry.$.ref;\n            let video = await YoutubeVideo.findOne({\n                where: {\n                    video_id: id,\n                }\n            });\n            if(video){\n                video.deleted_at = moment(entry.$.when).toDate();\n                video.save();\n            }\n        } else {\n\n        }\n    }\n}"]}