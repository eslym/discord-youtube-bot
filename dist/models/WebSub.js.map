{"version":3,"sources":["../src/models/WebSub.ts"],"names":[],"mappings":"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","file":"WebSub.js","sourcesContent":["import {BeforeValidate, Column, HasMany, Model, Table} from \"sequelize-typescript\";\nimport {DataTypes} from \"sequelize\";\nimport {parseStringPromise as parsexml} from \"xml2js\";\nimport {SnowflakeUtil} from \"discord.js\";\nimport crypto = require(\"crypto\");\nimport {YoutubeVideo} from \"./YoutubeVideo\";\nimport { Subscription } from \"./Subscription\";\n\nconst fetch = require(\"node-fetch\");\n\n@Table({tableName: 'web_subs', createdAt: 'created_at', updatedAt: 'updated_at', collate: 'utf8_bin'})\nexport class WebSub extends Model<WebSub> {\n\n    @BeforeValidate\n    protected static makeId(self: WebSub) {\n        if (!self.id) {\n            self.id = SnowflakeUtil.generate() as any;\n        }\n        if (!self.secret) {\n            self.secret = crypto.randomBytes(20).toString('base64');\n        }\n    }\n\n    @Column({type: DataTypes.BIGINT.UNSIGNED, primaryKey: true})\n    public id: number;\n\n    @Column({type: DataTypes.STRING, allowNull: false})\n    public youtube_channel: string;\n\n    @Column({type: DataTypes.STRING, allowNull: false})\n    public secret: string;\n\n    @Column({type: DataTypes.TEXT, allowNull: false})\n    public message: string;\n\n    @Column({type: DataTypes.DATE, allowNull: true})\n    public created_at: Date;\n\n    @Column({type: DataTypes.DATE, allowNull: true})\n    public updated_at: Date;\n\n    @Column({type: DataTypes.DATE, allowNull: true})\n    public expires_at: Date;\n\n    @HasMany(() => YoutubeVideo, {foreignKey: 'sub_id'})\n    public videos: YoutubeVideo[];\n\n    @HasMany(() => Subscription, {foreignKey: 'sub_id'})\n    public subscriptions: Subscription[];\n\n    public get topic_url(): string {\n        let url = new URL('https://www.youtube.com/xml/feeds/videos.xml');\n        let params = new URLSearchParams([['channel_id', this.youtube_channel]]);\n        url.search = params.toString();\n        return url.toString();\n    }\n\n    public get rss_url(): string {\n        let url = new URL('https://www.youtube.com/feeds/videos.xml');\n        let params = new URLSearchParams([['channel_id', this.youtube_channel]]);\n        url.search = params.toString();\n        return url.toString();\n    }\n\n    public get youtube_url(): string {\n        return `https://www.youtube.com/channel/${this.youtube_channel}`;\n    }\n\n    public async getTitle(): Promise<string | null> {\n        try {\n            let res = await fetch(this.rss_url);\n            let xml = await res.text();\n            let data = await parsexml(xml);\n            return data.feed.title;\n        } catch (_) {\n            return null;\n        }\n    }\n\n    public async subscribe(mode: 'subscribe' | 'unsubscribe' = 'subscribe') {\n        let data = new URLSearchParams();\n        data.append('hub.callback', `${process.env.WEBSUB_CALLBACK}/${this.id}`);\n        data.append('hub.mode', mode);\n        data.append('hub.topic', this.topic_url);\n        data.append('hub.secret', this.secret);\n        await fetch('https://pubsubhubbub.appspot.com/subscribe', {\n            method: 'post',\n            body: data,\n        }).catch((_) => {\n            console.error(\"Failed to subscribe \" + this.topic_url);\n        });\n    }\n}"]}