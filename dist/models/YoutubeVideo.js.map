{"version":3,"sources":["../src/models/YoutubeVideo.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,+DAA0F;AAC1F,yCAAoC;AACpC,qCAAgC;AAChC,iDAA4C;AAC5C,2CAA8C;AAC9C,oCAA+B;AAI/B,IAAa,YAAY,GAAzB,MAAa,YAAa,SAAQ,4BAAmB;IA2BjD,IAAW,GAAG;QACV,OAAO,mCAAmC,IAAI,CAAC,QAAQ,EAAE,CAAC;IAC9D,CAAC;IAEM,KAAK,CAAC,qBAAqB;QAC9B,IAAI,KAAK,GAAG,MAAM,aAAK,CAAC,GAAG,CAAC,WAAW,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC;QACxD,IAAI,KAAK,EAAE;YACP,OAAO,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;SAC5B;QACD,IAAI,GAAG,GAAG,MAAM,mBAAM,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC;YAC7C,EAAE,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC;YACnB,IAAI,EAAE,CAAC,SAAS,EAAE,sBAAsB,CAAC;SAC5C,CAAC,CAAC;QACH,IAAI,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,YAAY,KAAK,CAAC,EAAE;YACtC,OAAO,IAAI,CAAC;SACf;QACD,MAAM,aAAK,CAAC,GAAG,CACX,WAAW,IAAI,CAAC,QAAQ,EAAE,EAC1B,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,EACjC;YACI,EAAE,EAAE,CAAC;SACR,CACJ,CAAC;QACF,OAAO,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;IAC7B,CAAC;CACJ,CAAA;AAjDG;IADC,IAAA,6BAAM,EAAC,EAAC,IAAI,EAAE,qBAAS,CAAC,MAAM,EAAE,UAAU,EAAE,IAAI,EAAC,CAAC;;8CAC3B;AAIxB;IAFC,IAAA,iCAAU,EAAC,GAAG,EAAE,CAAC,eAAM,CAAC;IACxB,IAAA,6BAAM,EAAC,EAAC,IAAI,EAAE,qBAAS,CAAC,MAAM,CAAC,QAAQ,EAAE,SAAS,EAAE,KAAK,EAAC,CAAC;;+CACnC;AAGzB;IADC,IAAA,6BAAM,EAAC,EAAC,IAAI,EAAE,qBAAS,CAAC,IAAI,EAAE,SAAS,EAAE,IAAI,EAAC,CAAC;8BAChC,IAAI;6CAAC;AAGrB;IADC,IAAA,6BAAM,EAAC,EAAC,IAAI,EAAE,qBAAS,CAAC,IAAI,EAAE,SAAS,EAAE,IAAI,EAAC,CAAC;8BAC7B,IAAI;gDAAC;AAGxB;IADC,IAAA,6BAAM,EAAC,EAAC,IAAI,EAAE,qBAAS,CAAC,IAAI,EAAE,SAAS,EAAE,IAAI,EAAC,CAAC;8BAC7B,IAAI;gDAAC;AAGxB;IADC,IAAA,6BAAM,EAAC,EAAC,IAAI,EAAE,qBAAS,CAAC,IAAI,EAAE,SAAS,EAAE,IAAI,EAAC,CAAC;8BAC7B,IAAI;gDAAC;AAGxB;IADC,IAAA,gCAAS,EAAC,GAAG,EAAE,CAAC,eAAM,EAAE,EAAC,UAAU,EAAE,WAAW,EAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,EAAE,UAAU,EAAC,CAAC;8BACzE,eAAM;kDAAC;AAG5B;IADC,IAAA,8BAAO,EAAC,GAAG,EAAE,CAAC,2BAAY,EAAE,UAAU,CAAC;;mDACH;AAzB5B,YAAY;IADxB,IAAA,4BAAK,EAAC,EAAC,SAAS,EAAE,gBAAgB,EAAE,SAAS,EAAE,YAAY,EAAE,SAAS,EAAE,YAAY,EAAE,OAAO,EAAE,UAAU,EAAC,CAAC;GAC/F,YAAY,CAoDxB;AApDY,oCAAY","file":"YoutubeVideo.js","sourcesContent":["import {BelongsTo, Column, ForeignKey, HasMany, Model, Table} from \"sequelize-typescript\";\r\nimport {DataTypes} from \"sequelize\";\r\nimport {WebSub} from \"./WebSub\";\r\nimport {Notification} from \"./Notification\";\r\nimport {google, youtube_v3} from \"googleapis\";\r\nimport {redis} from \"../redis\";\r\nimport Schema$Video = youtube_v3.Schema$Video;\r\n\r\n@Table({tableName: 'youtube_videos', createdAt: 'created_at', updatedAt: 'updated_at', collate: 'utf8_bin'})\r\nexport class YoutubeVideo extends Model<YoutubeVideo> {\r\n\r\n    @Column({type: DataTypes.STRING, primaryKey: true})\r\n    public video_id: string;\r\n\r\n    @ForeignKey(() => WebSub)\r\n    @Column({type: DataTypes.BIGINT.UNSIGNED, allowNull: false})\r\n    public websub_id: number;\r\n\r\n    @Column({type: DataTypes.DATE, allowNull: true})\r\n    public live_at: Date;\r\n\r\n    @Column({type: DataTypes.DATE, allowNull: true})\r\n    public deleted_at: Date;\r\n\r\n    @Column({type: DataTypes.DATE, allowNull: true})\r\n    public created_at: Date;\r\n\r\n    @Column({type: DataTypes.DATE, allowNull: true})\r\n    public updated_at: Date;\r\n\r\n    @BelongsTo(() => WebSub, {foreignKey: 'websub_id', onDelete: 'cascade', onUpdate: 'restrict'})\r\n    public subscription: WebSub;\r\n\r\n    @HasMany(() => Notification, 'video_id')\r\n    public notifications: Notification[];\r\n\r\n    public get url(): string {\r\n        return `https://www.youtube.com/watch?v=${this.video_id}`;\r\n    }\r\n\r\n    public async fetchYoutubeVideoMeta(): Promise<Schema$Video> {\r\n        let cache = await redis.get(`ytVideo:${this.video_id}`);\r\n        if (cache) {\r\n            return JSON.parse(cache);\r\n        }\r\n        let res = await google.youtube('v3').videos.list({\r\n            id: [this.video_id],\r\n            part: ['snippet', 'liveStreamingDetails']\r\n        });\r\n        if (res.data.pageInfo.totalResults === 0) {\r\n            return null;\r\n        }\r\n        await redis.set(\r\n            `ytVideo:${this.video_id}`,\r\n            JSON.stringify(res.data.items[0]),\r\n            {\r\n                EX: 5\r\n            }\r\n        );\r\n        return res.data.items[0];\r\n    }\r\n}\r\n"]}