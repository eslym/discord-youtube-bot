{"version":3,"sources":["../src/bot.ts"],"names":[],"mappings":"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","file":"bot.js","sourcesContent":["import {\n    ApplicationCommand, ApplicationCommandPermissionData,\n    Client,\n    Collection,\n    Guild,\n    GuildResolvable,\n    Intents,\n    Snowflake\n} from \"discord.js\";\nimport {REST} from \"@discordjs/rest\";\nimport {Routes} from \"discord-api-types/v9\";\nimport {get as config} from \"./config\";\nimport {SlashCommandBuilder} from \"@discordjs/builders\";\nimport {SearchCommand} from \"./commands/SearchCommand\";\nimport {logger} from \"./logger\";\nimport {SubscribeCommand} from \"./commands/SubscribeCommand\";\nimport {UnsubscribeCommand} from \"./commands/UnsubscribeCommand\";\nimport cron = require('node-cron');\nimport {Notification} from \"./models/Notification\";\nimport {Op} from \"sequelize\";\nimport {YoutubeVideo} from \"./models/YoutubeVideo\";\nimport {google, youtube_v3} from \"googleapis\";\nimport Schema$VideoSnippet = youtube_v3.Schema$VideoSnippet;\nimport Dict = NodeJS.Dict;\n\nlet intents = new Intents();\n\nintents.add(\n    Intents.FLAGS.GUILDS,\n    Intents.FLAGS.GUILD_MEMBERS,\n    Intents.FLAGS.GUILD_INTEGRATIONS,\n    Intents.FLAGS.GUILD_MESSAGES,\n    Intents.FLAGS.DIRECT_MESSAGES,\n)\n\nexport const bot = new Client({intents});\n\nlet client = new REST({version: '9'});\nclient.setToken(config('discord.token'));\n\nlet commands = {\n    'search': SearchCommand,\n    'subscribe': SubscribeCommand,\n    'unsubscribe': UnsubscribeCommand,\n};\n\nexport async function setupCommands() {\n    const appId = config('discord.appId')\n    let route = Routes.applicationCommands(appId);\n    let command = new SlashCommandBuilder()\n        .setDefaultPermission(false)\n        .setName('youtube')\n        .setDescription('Youtube notification services');\n    Object.values(commands).forEach(c => {\n        command.addSubcommand(c.definition);\n    });\n    await client.put(route, {\n        body: [command.toJSON()]\n    });\n}\n\nasync function setGuildCommandPermissions(guild: Guild, cmds: Collection<Snowflake, ApplicationCommand<{ guild: GuildResolvable }>>) {\n    if (!guild.commands) return;\n    for (let command of cmds.values()) {\n        let permissions: ApplicationCommandPermissionData[] = [\n            {\n                id: guild.ownerId,\n                type: 'USER',\n                permission: true,\n            }\n        ];\n        await command.permissions.add({\n            guild, permissions\n        }).catch(err => logger.warn(`Failed to set permissions for /${command.name} on ${guild.name}`));\n    }\n}\n\nbot.on('ready', () => {\n    (async () => {\n        let guilds = await bot.guilds.fetch();\n        let cmds = await bot.application.commands.fetch();\n        for (let g of guilds.values()) {\n            let guild = await g.fetch();\n            await setGuildCommandPermissions(guild, cmds);\n        }\n        bot.on('guildCreate', (guild) => {\n            (async () => {\n                guild = await guild.fetch();\n                await setGuildCommandPermissions(guild, cmds);\n            })().catch((error) => {\n                logger.error(error);\n            });\n        });\n    })().catch(logger.error);\n    cron.schedule('* * * * *', ()=>{\n        (async ()=>{\n            let notifications = await Notification.findAll({\n                where: {\n                    notified_at: null,\n                    scheduled_at: {\n                        [Op.lte]: new Date()\n                    }\n                }\n            });\n            if(notifications.length === 0){\n                return;\n            }\n            let videos = await YoutubeVideo.findAll({\n                attributes: ['video_id'],\n                where: {\n                    video_id: {\n                        [Op.in]: notifications.map(n => n.video_id)\n                    }\n                }\n            });\n            let res = await google.youtube('v3').videos.list({\n                part: ['snippet', 'id'],\n                id: videos.map(v=>v.id),\n                maxResults: videos.length,\n            });\n            let videoData: Dict<Schema$VideoSnippet> = {};\n            for (let item of res.data.items){\n                videoData[item.id] = item.snippet;\n            }\n            for (let notification of notifications) {\n                let snippet = videoData[notification.video_id];\n                let url = new URL('https://www.youtube.com/watch');\n                url.searchParams.set('v', notification.video_id);\n                let sub = await notification.$get('subscription');\n                await sub.notifyStarting(url.toString(), snippet.channelTitle);\n                notification.notified_at = new Date();\n                notification.save();\n            }\n        })().catch((error) => {\n            logger.error(error);\n        });\n    });\n});\n\nbot.on('interactionCreate', (interaction) => {\n    if (interaction.isCommand() && interaction.commandName === 'youtube') {\n        let cmd = interaction.options.getSubcommand(true);\n        logger.info(`${interaction.user.tag}:${interaction.user.id} run command \"/${interaction.commandName} ${cmd}\"`)\n        commands[cmd].handle(interaction).catch(logger.error);\n    }\n});\n"]}