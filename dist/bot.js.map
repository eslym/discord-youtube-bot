{"version":3,"sources":["../src/bot.ts"],"names":[],"mappings":"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","file":"bot.js","sourcesContent":["import {\n    ApplicationCommand, ApplicationCommandPermissionData,\n    Client,\n    Collection,\n    Guild,\n    GuildResolvable,\n    Intents,\n    Snowflake\n} from \"discord.js\";\nimport {REST} from \"@discordjs/rest\";\nimport {Routes} from \"discord-api-types/v9\";\nimport {get as config} from \"./config\";\nimport {SlashCommandBuilder} from \"@discordjs/builders\";\nimport {SearchCommand} from \"./commands/SearchCommand\";\nimport {logger} from \"./logger\";\nimport {SubscribeCommand} from \"./commands/SubscribeCommand\";\nimport {UnsubscribeCommand} from \"./commands/UnsubscribeCommand\";\n\nlet intents = new Intents();\n\nintents.add(\n    Intents.FLAGS.GUILDS,\n    Intents.FLAGS.GUILD_MEMBERS,\n    Intents.FLAGS.GUILD_INTEGRATIONS,\n    Intents.FLAGS.GUILD_MESSAGES\n)\n\nexport const bot = new Client({intents});\n\nlet client = new REST({version: '9'});\nclient.setToken(config('discord.token'));\n\nlet commands = {\n    'search': SearchCommand,\n    'subscribe': SubscribeCommand,\n    'unsubscribe': UnsubscribeCommand,\n};\n\nexport async function setupCommands() {\n    const appId = config('discord.appId')\n    let route = Routes.applicationCommands(appId);\n    let command = new SlashCommandBuilder()\n        .setDefaultPermission(false)\n        .setName('youtube')\n        .setDescription('Youtube notification services');\n    Object.values(commands).forEach(c => {\n        command.addSubcommand(c.definition);\n    });\n    await client.put(route, {\n        body: [command.toJSON()]\n    });\n}\n\nasync function setGuildCommandPermissions(guild: Guild, cmds: Collection<Snowflake, ApplicationCommand<{ guild: GuildResolvable }>>) {\n    if (!guild.commands) return;\n    for (let command of cmds.values()) {\n        try {\n            let permissions: ApplicationCommandPermissionData[] = [\n                {\n                    id: guild.ownerId,\n                    type: 'USER',\n                    permission: true,\n                }\n            ];\n            await command.permissions.add({\n                guild, permissions\n            });\n        } catch (err) {\n            logger.warn(`Failed to set permissions for /${command.name} on ${guild.name}`);\n        }\n    }\n}\n\nbot.on('ready', () => {\n    (async () => {\n        let guilds = await bot.guilds.fetch();\n        let cmds = await bot.application.commands.fetch();\n        for (let g of guilds.values()) {\n            let guild = await g.fetch();\n            await setGuildCommandPermissions(guild, cmds);\n        }\n        bot.on('guildCreate', (guild) => {\n            (async () => {\n                guild = await guild.fetch();\n                await setGuildCommandPermissions(guild, cmds);\n            })().catch((error) => {\n                logger.error(error);\n            });\n        });\n    })().catch(logger.error);\n});\n\nbot.on('interactionCreate', (interaction) => {\n    if (interaction.isCommand() && interaction.commandName === 'youtube') {\n        let cmd = interaction.options.getSubcommand(true);\n        logger.info(`${interaction.user.tag}:${interaction.user.id} run a command \"/${interaction.commandName} ${cmd}\"`)\n        commands[cmd].handle(interaction).catch(logger.error);\n    }\n});\n"]}